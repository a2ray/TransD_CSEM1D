<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,177" id="srcline177">177</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,178" id="srcline178">178</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S73T44U1802">ErKernels</span>,<span class="var type1" id="S74T45U1803">EbKernels</span>,<span class="var type1" id="S75T45U1804">HrKernels</span>,<span class="var type1" id="S76T44U1805">HbKernels</span>,<span class="var type1" id="S77T45U1806">EzKernels</span>,<span class="var type1" id="S78T19U1807">HzKernels</span>]<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,179" id="srcline179">179</a></span><span class="line">        = getCSEM1DKernels_aniso_hed(<span class="var type1" id="S79T1U1810">krho</span>,<span class="var type1" id="S80T1U1811">f</span>,<span class="var type1" id="S81T1U1812">zRx</span>,<span class="var type1" id="S82T1U1813">zTx</span>,<span class="var type1" id="S83T3U1814">z</span>,<span class="var type1" id="S84T32U1815">sig</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,180" id="srcline180">180</a></span><span class="line"><span class="comment">%sig(1,:) contains the horizontal conductivities</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,181" id="srcline181">181</a></span><span class="line"><span class="comment">%sig(2,:) contains the vertical conductivities</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,182" id="srcline182">182</a></span><span class="line">coder.extrinsic (<span class="string">'beep'</span>,<span class="string">'disp'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,183" id="srcline183">183</a></span><span class="line"><span class="comment">%a codegen debug</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,184" id="srcline184">184</a></span><span class="line"><span class="mxinfo" id="T44:U13"><span class="var type1" id="S73T44U1825">ErKernels</span>         = <span class="mxinfo" id="T44:U15">[<span class="mxinfo" id="T19:U16">1i</span>; <span class="mxinfo" id="T19:U17">1i</span>; <span class="mxinfo" id="T19:U18">1i</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,185" id="srcline185">185</a></span><span class="line"><span class="mxinfo" id="T45:U19"><span class="var type1" id="S74T45U1835">EbKernels</span>         = <span class="mxinfo" id="T45:U21">[<span class="mxinfo" id="T19:U22">1i</span>; <span class="mxinfo" id="T19:U23">1i</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,186" id="srcline186">186</a></span><span class="line"><span class="mxinfo" id="T45:U24"><span class="var type1" id="S77T45U1843">EzKernels</span>         = <span class="mxinfo" id="T45:U26">[<span class="mxinfo" id="T19:U27">1i</span>;  <span class="mxinfo" id="T19:U28">1i</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,187" id="srcline187">187</a></span><span class="line"><span class="mxinfo" id="T45:U29"><span class="var type1" id="S75T45U1851">HrKernels</span>         = <span class="mxinfo" id="T45:U31">[<span class="mxinfo" id="T19:U32">1i</span>; <span class="mxinfo" id="T19:U33">1i</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,188" id="srcline188">188</a></span><span class="line"><span class="mxinfo" id="T44:U34"><span class="var type1" id="S76T44U1859">HbKernels</span>         = <span class="mxinfo" id="T44:U36">[<span class="mxinfo" id="T19:U37">1i</span>; <span class="mxinfo" id="T19:U38">1i</span>; <span class="mxinfo" id="T19:U39">1i</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,189" id="srcline189">189</a></span><span class="line"><span class="mxinfo" id="T19:U40"><span class="var type1" id="S78T19U1869">HzKernels</span>         = <span class="mxinfo" id="T19:U42">[1i]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,190" id="srcline190">190</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,191" id="srcline191">191</a></span><span class="line"><span class="comment">% set the origin to zTx=0</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,192" id="srcline192">192</a></span><span class="line">    <span class="mxinfo" id="T3:U43"><span class="var type1" id="S83T3U1875">z</span>       = <span class="mxinfo" id="T3:U45"><span class="var type1" id="S83T3U1877">z</span>-<span class="var type1" id="S82T1U1878">zTx</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,193" id="srcline193">193</a></span><span class="line">    <span class="mxinfo" id="T1:U48"><span class="var type1" id="S81T1U1881">zRx</span>     = <span class="mxinfo" id="T1:U50"><span class="var type1" id="S81T1U1883">zRx</span>-<span class="var type1" id="S82T1U1884">zTx</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,194" id="srcline194">194</a></span><span class="line">    <span class="mxinfo" id="T1:U53"><span class="var type1" id="S82T1U1887">zTx</span>     = <span class="mxinfo" id="T1:U55">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,195" id="srcline195">195</a></span><span class="line"><span class="comment">% will need these variables</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,196" id="srcline196">196</a></span><span class="line">    <span class="mxinfo" id="T1:U56"><span class="var type1" id="S86T1U1891">mu</span>      = <span class="mxinfo" id="T1:U58">4*pi*10^-7</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,197" id="srcline197">197</a></span><span class="line">    <span class="mxinfo" id="T1:U59"><span class="var type1" id="S88T1U1903">eps0</span>    = <span class="mxinfo" id="T1:U61">8.854e-12</span></span>;<span class="comment">%won't need</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,198" id="srcline198">198</a></span><span class="line">    <span class="comment">%global omega   </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,199" id="srcline199">199</a></span><span class="line">    <span class="mxinfo" id="T1:U62"><span class="var type1" id="S89T1U1907">omega</span> = <span class="mxinfo" id="T1:U64"><span class="mxinfo" id="T1:U65">2*pi</span>*<span class="var type1" id="S80T1U1913">f</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,200" id="srcline200">200</a></span><span class="line">    <span class="mxinfo" id="T33:U67"><span class="var type1" id="S90T33U1916">epsc</span>    = <span class="mxinfo" id="T33:U69"><span class="var type1" id="S88T1U1918">eps0</span> + <span class="mxinfo" id="T33:U71"><span class="mxinfo" id="T33:U72"><span class="mxinfo" id="T19:U73">1i</span>*<span class="var type1" id="S84T32U1922">sig</span></span>/<span class="var type1" id="S89T1U1923">omega</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,201" id="srcline201">201</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,202" id="srcline202">202</a></span><span class="line"><span class="comment">% prho=krho/omega</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,203" id="srcline203">203</a></span><span class="line">    <span class="mxinfo" id="T34:U76"><span class="var type1" id="S91T34U1926">pzI</span>=<span class="mxinfo" id="T34:U78">sqrt(<span class="mxinfo" id="T34:U79"><span class="mxinfo" id="T34:U80"><span class="mxinfo" id="T1:U81"><span class="var type1" id="S86T1U1931">mu</span></span>*<span class="mxinfo" id="T34:U83"><span class="var type1" id="S90T33U1933">epsc</span>(<span class="mxinfo" id="T1:U85">1</span>,:)</span></span> - <span class="mxinfo" id="T1:U86">(<span class="mxinfo" id="T1:U87"><span class="var type1" id="S79T1U1939">krho</span>/<span class="var type1" id="S89T1U1940">omega</span></span>)^2</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,204" id="srcline204">204</a></span><span class="line">    <span class="mxinfo" id="T34:U90"><span class="var type1" id="S93T34U1944">pzII</span>=<span class="mxinfo" id="T34:U92">sqrt(<span class="mxinfo" id="T34:U93"><span class="mxinfo" id="T34:U94"><span class="mxinfo" id="T1:U95"><span class="var type1" id="S86T1U1949">mu</span></span>*<span class="mxinfo" id="T34:U97"><span class="var type1" id="S90T33U1951">epsc</span>(<span class="mxinfo" id="T1:U99">1</span>,:)</span></span> - <span class="mxinfo" id="T34:U100"><span class="mxinfo" id="T34:U101"><span class="mxinfo" id="T34:U102"><span class="var type1" id="S90T33U1957">epsc</span>(<span class="mxinfo" id="T1:U104">1</span>,:)</span>./<span class="mxinfo" id="T34:U105"><span class="var type1" id="S90T33U1961">epsc</span>(<span class="mxinfo" id="T1:U107">2</span>,:)</span></span>*<span class="mxinfo" id="T1:U108">(<span class="mxinfo" id="T1:U109"><span class="var type1" id="S79T1U1967">krho</span>/<span class="var type1" id="S89T1U1968">omega</span></span>)^2</span></span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,205" id="srcline205">205</a></span><span class="line">    <span class="comment">%sanity check for wavenumber</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,206" id="srcline206">206</a></span><span class="line">    <span class="mxinfo" id="T36:U112"><span class="var type1" id="S94T36U1972">index</span>=<span class="mxinfo" id="T36:U114"><span class="mxinfo" id="T3:U115">imag(<span class="var type1" id="S91T34U1976">pzI</span>)</span>&lt;<span class="mxinfo" id="T1:U117">0</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,207" id="srcline207">207</a></span><span class="line">    <span class="mxinfo" id="T34:U118"><span class="mxinfo" id="T34:U119"><span class="var type1" id="S91T34U1981">pzI</span>(<span class="var type1" id="S94T36U1982">index</span>)</span>=<span class="mxinfo" id="T34:U122">-<span class="mxinfo" id="T34:U123"><span class="var type1" id="S91T34U1985">pzI</span>(<span class="var type1" id="S94T36U1986">index</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,208" id="srcline208">208</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,209" id="srcline209">209</a></span><span class="line">    <span class="mxinfo" id="T36:U126"><span class="var type1" id="S94T36U1989">index</span>=<span class="mxinfo" id="T36:U128"><span class="mxinfo" id="T3:U129">imag(<span class="var type1" id="S93T34U1993">pzII</span>)</span>&lt;<span class="mxinfo" id="T1:U131">0</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,210" id="srcline210">210</a></span><span class="line">    <span class="mxinfo" id="T34:U132"><span class="mxinfo" id="T34:U133"><span class="var type1" id="S93T34U1998">pzII</span>(<span class="var type1" id="S94T36U1999">index</span>)</span>=<span class="mxinfo" id="T34:U136">-<span class="mxinfo" id="T34:U137"><span class="var type1" id="S93T34U2002">pzII</span>(<span class="var type1" id="S94T36U2003">index</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,211" id="srcline211">211</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,212" id="srcline212">212</a></span><span class="line"><span class="comment">% reflection coefficients (downward) for an interface: pzI for TE, pzII for TM   </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,213" id="srcline213">213</a></span><span class="line">    <span class="mxinfo" id="T34:U140"><span class="var type1" id="S96T34U2006">rTE</span>=<span class="mxinfo" id="T34:U142">(<span class="mxinfo" id="T34:U143"><span class="mxinfo" id="T34:U144"><span class="var type1" id="S91T34U2011">pzI</span>(<span class="mxinfo" id="T1:U146">1</span>:<span class="mxinfo" id="T1:U147"><span class="mxinfo" id="T1:U148">end</span>-<span class="mxinfo" id="T1:U149">1</span></span>)</span> - <span class="mxinfo" id="T34:U150"><span class="var type1" id="S91T34U2019">pzI</span>(<span class="mxinfo" id="T1:U152">2</span>:<span class="mxinfo" id="T1:U153">end</span>)</span></span>)./(<span class="mxinfo" id="T34:U154"><span class="mxinfo" id="T34:U155"><span class="var type1" id="S91T34U2027">pzI</span>(<span class="mxinfo" id="T1:U157">1</span>:<span class="mxinfo" id="T1:U158"><span class="mxinfo" id="T1:U159">end</span>-<span class="mxinfo" id="T1:U160">1</span></span>)</span> + <span class="mxinfo" id="T34:U161"><span class="var type1" id="S91T34U2035">pzI</span>(<span class="mxinfo" id="T1:U163">2</span>:<span class="mxinfo" id="T1:U164">end</span>)</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,214" id="srcline214">214</a></span><span class="line">    <span class="mxinfo" id="T34:U165"><span class="var type1" id="S98T34U2042">rTM</span>=<span class="mxinfo" id="T34:U167">(<span class="mxinfo" id="T34:U168"><span class="mxinfo" id="T34:U169"><span class="mxinfo" id="T34:U170"><span class="var type1" id="S90T33U2048">epsc</span>(<span class="mxinfo" id="T1:U172">1</span>,<span class="mxinfo" id="T1:U173"><span class="mxinfo" id="T1:U174">1</span>:<span class="mxinfo" id="T1:U175"><span class="mxinfo" id="T1:U176">end</span>-<span class="mxinfo" id="T1:U177">1</span></span></span>)</span>.*<span class="mxinfo" id="T34:U178"><span class="var type1" id="S93T34U2057">pzII</span>(<span class="mxinfo" id="T1:U180">2</span>:<span class="mxinfo" id="T1:U181">end</span>)</span></span> - <span class="mxinfo" id="T34:U182"><span class="mxinfo" id="T34:U183"><span class="var type1" id="S90T33U2064">epsc</span>(<span class="mxinfo" id="T1:U185">1</span>,<span class="mxinfo" id="T1:U186"><span class="mxinfo" id="T1:U187">2</span>:<span class="mxinfo" id="T1:U188">end</span></span>)</span>.*<span class="mxinfo" id="T34:U189"><span class="var type1" id="S93T34U2071">pzII</span>(<span class="mxinfo" id="T1:U191">1</span>:<span class="mxinfo" id="T1:U192"><span class="mxinfo" id="T1:U193">end</span>-<span class="mxinfo" id="T1:U194">1</span></span>)</span></span></span>)./<span class="keyword">...</span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,215" id="srcline215">215</a></span><span class="line"><span class="mxinfo" id="T34:U165"><span class="mxinfo" id="T34:U167">        (<span class="mxinfo" id="T34:U195"><span class="mxinfo" id="T34:U196"><span class="mxinfo" id="T34:U197"><span class="var type1" id="S90T33U2082">epsc</span>(<span class="mxinfo" id="T1:U199">1</span>,<span class="mxinfo" id="T1:U200"><span class="mxinfo" id="T1:U201">1</span>:<span class="mxinfo" id="T1:U202"><span class="mxinfo" id="T1:U203">end</span>-<span class="mxinfo" id="T1:U204">1</span></span></span>)</span>.*<span class="mxinfo" id="T34:U205"><span class="var type1" id="S93T34U2091">pzII</span>(<span class="mxinfo" id="T1:U207">2</span>:<span class="mxinfo" id="T1:U208">end</span>)</span></span> + <span class="mxinfo" id="T34:U209"><span class="mxinfo" id="T34:U210"><span class="var type1" id="S90T33U2098">epsc</span>(<span class="mxinfo" id="T1:U212">1</span>,<span class="mxinfo" id="T1:U213"><span class="mxinfo" id="T1:U214">2</span>:<span class="mxinfo" id="T1:U215">end</span></span>)</span>.*<span class="mxinfo" id="T34:U216"><span class="var type1" id="S93T34U2105">pzII</span>(<span class="mxinfo" id="T1:U218">1</span>:<span class="mxinfo" id="T1:U219"><span class="mxinfo" id="T1:U220">end</span>-<span class="mxinfo" id="T1:U221">1</span></span>)</span></span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,216" id="srcline216">216</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,217" id="srcline217">217</a></span><span class="line"><span class="comment">%         % Find the layer containing the transmitter:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,218" id="srcline218">218</a></span><span class="line">    <span class="comment">%for codegen, hardcoding</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,219" id="srcline219">219</a></span><span class="line"><span class="comment">%    iTxLayer =2;iRxLayer =2;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,220" id="srcline220">220</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,221" id="srcline221">221</a></span><span class="line">            <span class="mxinfo" id="T3:U222"><span class="var type1" id="S99T3U2114">iTxLayer</span> = <span class="mxinfo" id="T3:U224">find(<span class="mxinfo" id="T36:U225"><span class="var type1" id="S83T3U2118">z</span>&lt;<span class="var type1" id="S82T1U2119">zTx</span></span>,1,<span class="string">'last'</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,222" id="srcline222">222</a></span><span class="line">            <span class="keyword">if</span> <span class="mxinfo" id="T5:U228">isempty(<span class="var type1" id="S99T3U2126">iTxLayer</span>)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,223" id="srcline223">223</a></span><span class="line">                <span class="mxinfo" id="T3:U230"><span class="var type1" id="S99T3U2129">iTxLayer</span> = <span class="mxinfo" id="T1:U232">length(<span class="var type1" id="S83T3U2132">z</span>)</span></span>; <span class="comment">% in the last layer</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,224" id="srcline224">224</a></span><span class="line">            <span class="keyword">end</span>    </span></span>
<span class="srcline"><span class="lineno"><a href="1,225" id="srcline225">225</a></span><span class="line">        <span class="mxinfo" id="T1:U234"><span class="var type1" id="S99T1U2135">iTxLayer</span> =<span class="mxinfo" id="T1:U236"><span class="var type1" id="S99T3U2137">iTxLayer</span>(<span class="mxinfo" id="T1:U238">1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,226" id="srcline226">226</a></span><span class="line">        <span class="comment">% Find the layer containing the receiver:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,227" id="srcline227">227</a></span><span class="line">        <span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,228" id="srcline228">228</a></span><span class="line">            <span class="mxinfo" id="T3:U239"><span class="var type1" id="S103T3U2141">iRxLayer</span> = <span class="mxinfo" id="T3:U241">find(<span class="mxinfo" id="T36:U242"><span class="var type1" id="S83T3U2145">z</span>&lt;<span class="var type1" id="S81T1U2146">zRx</span></span>,1,<span class="string">'last'</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,229" id="srcline229">229</a></span><span class="line">            <span class="keyword">if</span> <span class="mxinfo" id="T5:U245">isempty(<span class="var type1" id="S103T3U2153">iRxLayer</span>)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,230" id="srcline230">230</a></span><span class="line">                <span class="mxinfo" id="T3:U247"><span class="var type1" id="S103T3U2156">iRxLayer</span> = <span class="mxinfo" id="T1:U249">length(<span class="var type1" id="S83T3U2159">z</span>)</span></span>; <span class="comment">% in the last layer</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,231" id="srcline231">231</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,232" id="srcline232">232</a></span><span class="line">        <span class="mxinfo" id="T1:U251"><span class="var type1" id="S103T1U2162">iRxLayer</span> =<span class="mxinfo" id="T1:U253"><span class="var type1" id="S103T3U2164">iRxLayer</span>(<span class="mxinfo" id="T1:U255">1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,233" id="srcline233">233</a></span><span class="line">            <span class="keyword">if</span> <span class="mxinfo" id="T5:U256"><span class="var type1" id="S99T1U2169">iTxLayer</span> ~= <span class="var type1" id="S103T1U2170">iRxLayer</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,234" id="srcline234">234</a></span><span class="line">                <span class="extrinsicFcn" id="F310N2:B2173">beep</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,235" id="srcline235">235</a></span><span class="line">                <span class="extrinsicFcn" id="F311N3:B2176">disp</span>(<span class="string">'Error, transmitter and receiver need to be located in the same layer! Stopping'</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,236" id="srcline236">236</a></span><span class="line">                <span class="keyword">return</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,237" id="srcline237">237</a></span><span class="line">            <span class="keyword">end</span>  </span></span>
<span class="srcline"><span class="lineno"><a href="1,238" id="srcline238">238</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,239" id="srcline239">239</a></span><span class="line"><span class="comment">% kernels</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,240" id="srcline240">240</a></span><span class="line"><span class="comment">% TE mode, pzI</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,241" id="srcline241">241</a></span><span class="line">    <span class="mxinfo" id="T19:U259">[<span class="var type1" id="S106T19U2182">Rs_u</span>,<span class="var type1" id="S107T19U2183">Rs_d</span>]       = <span class="fcn" id="F214N10:B2185">stacks</span>(<span class="var type1" id="S91T34U2186">pzI</span>,<span class="var type1" id="S99T1U2187">iTxLayer</span>,<span class="var type1" id="S96T34U2188">rTE</span>,<span class="var type1" id="S83T3U2189">z</span>,<span class="var type1" id="S89T1U2190">omega</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,242" id="srcline242">242</a></span><span class="line">    <span class="mxinfo" id="T19:U267">[<span class="var type1" id="S109T19U2194">curlyRA</span>,<span class="var type1" id="S110T19U2195">curlyRD</span>,<span class="mxinfo" id="T1:U270"><span class="mxinfo" id="T1:U271">~</span></span>,<span class="mxinfo" id="T1:U272"><span class="mxinfo" id="T1:U273">~</span></span>] = <span class="fcn" id="F215N9:B2199">get_curly_R</span>(<span class="var type1" id="S106T19U2200">Rs_u</span>,<span class="var type1" id="S107T19U2201">Rs_d</span>,<span class="mxinfo" id="T19:U276"><span class="var type1" id="S91T34U2203">pzI</span>(<span class="var type1" id="S99T1U2204">iTxLayer</span>)</span>,<span class="var type1" id="S81T1U2205">zRx</span>,<span class="var type1" id="S83T3U2206">z</span>,<span class="var type1" id="S99T1U2207">iTxLayer</span>,<span class="var type1" id="S89T1U2208">omega</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,243" id="srcline243">243</a></span><span class="line">    <span class="mxinfo" id="T19:U283"><span class="var type1" id="S112T19U2211">gA_TE</span>             = <span class="mxinfo" id="T19:U285"><span class="mxinfo" id="T19:U286"><span class="mxinfo" id="T1:U287"><span class="var type1" id="S86T1U2214">mu</span></span>/<span class="mxinfo" id="T19:U289"><span class="var type1" id="S91T34U2216">pzI</span>(<span class="var type1" id="S99T1U2217">iTxLayer</span>)</span></span>*<span class="var type1" id="S109T19U2218">curlyRA</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,244" id="srcline244">244</a></span><span class="line">    <span class="mxinfo" id="T19:U293"><span class="var type1" id="S113T19U2221">gD_TE</span>             = <span class="var type1" id="S110T19U2222">curlyRD</span></span>;        </span></span>
<span class="srcline"><span class="lineno"><a href="1,245" id="srcline245">245</a></span><span class="line">    <span class="comment">%[Rs_uH,Rs_dH]     = stacks(pzI,iTxLayer,-rTE,z);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,246" id="srcline246">246</a></span><span class="line"><span class="comment">% TM mode, pzII</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,247" id="srcline247">247</a></span><span class="line">    <span class="mxinfo" id="T19:U296">[<span class="var type1" id="S106T19U2226">Rs_u</span>,<span class="var type1" id="S107T19U2227">Rs_d</span>]       = <span class="fcn" id="F214N10:B2229">stacks</span>(<span class="var type1" id="S93T34U2230">pzII</span>,<span class="var type1" id="S99T1U2231">iTxLayer</span>,<span class="var type1" id="S98T34U2232">rTM</span>,<span class="var type1" id="S83T3U2233">z</span>,<span class="var type1" id="S89T1U2234">omega</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,248" id="srcline248">248</a></span><span class="line">    <span class="mxinfo" id="T19:U304">[<span class="var type1" id="S109T19U2238">curlyRA</span>,<span class="var type1" id="S110T19U2239">curlyRD</span>,<span class="var type1" id="S114T19U2240">curlyRB</span>,<span class="var type1" id="S115T19U2241">curlyRC</span>] = <span class="fcn" id="F215N9:B2243">get_curly_R</span>(<span class="var type1" id="S106T19U2244">Rs_u</span>,<span class="var type1" id="S107T19U2245">Rs_d</span>,<span class="mxinfo" id="T19:U311"><span class="var type1" id="S93T34U2247">pzII</span>(<span class="var type1" id="S99T1U2248">iTxLayer</span>)</span>,<span class="var type1" id="S81T1U2249">zRx</span>,<span class="var type1" id="S83T3U2250">z</span>,<span class="var type1" id="S99T1U2251">iTxLayer</span>,<span class="var type1" id="S89T1U2252">omega</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,249" id="srcline249">249</a></span><span class="line">    <span class="mxinfo" id="T19:U318"><span class="var type1" id="S116T19U2255">gA_TM</span>             = <span class="mxinfo" id="T19:U320"><span class="mxinfo" id="T19:U321"><span class="mxinfo" id="T19:U322"><span class="var type1" id="S93T34U2259">pzII</span>(<span class="var type1" id="S99T1U2260">iTxLayer</span>)</span>/<span class="mxinfo" id="T19:U325"><span class="var type1" id="S90T33U2262">epsc</span>(<span class="mxinfo" id="T1:U327">1</span>,<span class="var type1" id="S99T1U2264">iTxLayer</span>)</span></span>*<span class="var type1" id="S109T19U2265">curlyRA</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,250" id="srcline250">250</a></span><span class="line">    <span class="mxinfo" id="T19:U330"><span class="var type1" id="S117T19U2268">gD_TM</span>             = <span class="var type1" id="S110T19U2269">curlyRD</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,251" id="srcline251">251</a></span><span class="line">    <span class="mxinfo" id="T19:U333"><span class="var type1" id="S118T19U2272">gB_TM</span>             = <span class="var type1" id="S114T19U2273">curlyRB</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,252" id="srcline252">252</a></span><span class="line">    <span class="mxinfo" id="T19:U336"><span class="var type1" id="S119T19U2276">gC_TM</span>             = <span class="mxinfo" id="T19:U338"><span class="mxinfo" id="T19:U339"><span class="mxinfo" id="T19:U340"><span class="var type1" id="S90T33U2280">epsc</span>(<span class="mxinfo" id="T1:U342">1</span>,<span class="var type1" id="S99T1U2282">iTxLayer</span>)</span>/<span class="mxinfo" id="T19:U344"><span class="var type1" id="S93T34U2284">pzII</span>(<span class="var type1" id="S99T1U2285">iTxLayer</span>)</span></span>*<span class="var type1" id="S115T19U2286">curlyRC</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,253" id="srcline253">253</a></span><span class="line">    <span class="comment">%[Rs_uH,Rs_dH]     = stacks(pzII,iTxLayer,-rTM,z);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,254" id="srcline254">254</a></span><span class="line"><span class="comment">% Kernels according to Loseth, without the bessel functions multiplied</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,255" id="srcline255">255</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,256" id="srcline256">256</a></span><span class="line">    <span class="comment">%Er</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,257" id="srcline257">257</a></span><span class="line">    <span class="mxinfo" id="T19:U348"><span class="var type1" id="S120T19U2289">J0</span>                = <span class="mxinfo" id="T19:U350"><span class="mxinfo" id="T19:U351"><span class="mxinfo" id="T19:U352"><span class="mxinfo" id="T1:U353">-<span class="var type1" id="S79T1U2294">krho</span></span>*<span class="var type1" id="S116T19U2295">gA_TM</span></span>/<span class="mxinfo" id="T1:U356">4</span></span>/<span class="mxinfo" id="T1:U357">pi</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,258" id="srcline258">258</a></span><span class="line">    <span class="mxinfo" id="T19:U358"><span class="var type1" id="S121T19U2301">J1</span>                = <span class="mxinfo" id="T19:U360"><span class="mxinfo" id="T19:U361"><span class="mxinfo" id="T19:U362">-(<span class="mxinfo" id="T19:U363"><span class="var type1" id="S112T19U2307">gA_TE</span> - <span class="var type1" id="S116T19U2308">gA_TM</span></span>)</span>/<span class="mxinfo" id="T1:U366">4</span></span>/<span class="mxinfo" id="T1:U367">pi</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,259" id="srcline259">259</a></span><span class="line">    <span class="mxinfo" id="T19:U368"><span class="var type1" id="S122T19U2314">J1V</span>               = <span class="mxinfo" id="T19:U370"><span class="mxinfo" id="T19:U371"><span class="mxinfo" id="T19:U372"><span class="mxinfo" id="T1:U373"><span class="var type1" id="S79T1U2319">krho</span>^2</span>*<span class="var type1" id="S118T19U2321">gB_TM</span></span>*<span class="mxinfo" id="T19:U376">1i</span></span>/(<span class="mxinfo" id="T19:U377"><span class="mxinfo" id="T1:U378"><span class="mxinfo" id="T1:U379">4*pi</span>*<span class="var type1" id="S89T1U2330">omega</span></span>*<span class="mxinfo" id="T19:U381"><span class="var type1" id="S90T33U2332">epsc</span>(<span class="mxinfo" id="T1:U383">2</span>,<span class="var type1" id="S99T1U2334">iTxLayer</span>)</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,260" id="srcline260">260</a></span><span class="line">    <span class="mxinfo" id="T44:U385"><span class="var type1" id="S73T44U2337">ErKernels</span>         = <span class="mxinfo" id="T44:U387">[<span class="var type1" id="S120T19U2340">J0</span>; <span class="var type1" id="S121T19U2342">J1</span> ; <span class="var type1" id="S122T19U2344">J1V</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,261" id="srcline261">261</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,262" id="srcline262">262</a></span><span class="line">    <span class="comment">%Eb</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,263" id="srcline263">263</a></span><span class="line">    <span class="mxinfo" id="T19:U391"><span class="var type1" id="S120T19U2347">J0</span>                = <span class="mxinfo" id="T19:U393"><span class="mxinfo" id="T19:U394"><span class="mxinfo" id="T19:U395"><span class="var type1" id="S79T1U2351">krho</span>*<span class="var type1" id="S112T19U2352">gA_TE</span></span>/<span class="mxinfo" id="T1:U398">4</span></span>/<span class="mxinfo" id="T1:U399">pi</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,264" id="srcline264">264</a></span><span class="line">    <span class="mxinfo" id="T19:U400"><span class="var type1" id="S121T19U2358">J1</span>                = <span class="mxinfo" id="T19:U402"><span class="mxinfo" id="T19:U403"><span class="mxinfo" id="T19:U404">-(<span class="mxinfo" id="T19:U405"><span class="var type1" id="S112T19U2364">gA_TE</span> - <span class="var type1" id="S116T19U2365">gA_TM</span></span>)</span>/<span class="mxinfo" id="T1:U408">4</span></span>/<span class="mxinfo" id="T1:U409">pi</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,265" id="srcline265">265</a></span><span class="line">    <span class="mxinfo" id="T45:U410"><span class="var type1" id="S74T45U2371">EbKernels</span>         = <span class="mxinfo" id="T45:U412">[<span class="var type1" id="S120T19U2374">J0</span>; <span class="var type1" id="S121T19U2376">J1</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,266" id="srcline266">266</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,267" id="srcline267">267</a></span><span class="line">    <span class="comment">%Hr</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,268" id="srcline268">268</a></span><span class="line">    <span class="mxinfo" id="T19:U415"><span class="var type1" id="S120T19U2379">J0</span>                = <span class="mxinfo" id="T19:U417"><span class="mxinfo" id="T19:U418"><span class="mxinfo" id="T19:U419"><span class="mxinfo" id="T1:U420">-<span class="var type1" id="S79T1U2384">krho</span></span>*<span class="var type1" id="S113T19U2385">gD_TE</span></span>/<span class="mxinfo" id="T1:U423">4</span></span>/<span class="mxinfo" id="T1:U424">pi</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,269" id="srcline269">269</a></span><span class="line">    <span class="mxinfo" id="T19:U425"><span class="var type1" id="S121T19U2391">J1</span>                = <span class="mxinfo" id="T19:U427"><span class="mxinfo" id="T19:U428">(<span class="mxinfo" id="T19:U429"><span class="var type1" id="S113T19U2396">gD_TE</span> - <span class="var type1" id="S117T19U2397">gD_TM</span></span>)/<span class="mxinfo" id="T1:U432">4</span></span>/<span class="mxinfo" id="T1:U433">pi</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,270" id="srcline270">270</a></span><span class="line">    <span class="mxinfo" id="T45:U434"><span class="var type1" id="S75T45U2403">HrKernels</span>         = <span class="mxinfo" id="T45:U436">[<span class="var type1" id="S120T19U2406">J0</span>; <span class="var type1" id="S121T19U2408">J1</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,271" id="srcline271">271</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,272" id="srcline272">272</a></span><span class="line">    <span class="comment">%Hb</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,273" id="srcline273">273</a></span><span class="line">    <span class="mxinfo" id="T19:U439"><span class="var type1" id="S120T19U2411">J0</span>                = <span class="mxinfo" id="T19:U441"><span class="mxinfo" id="T19:U442"><span class="mxinfo" id="T19:U443"><span class="mxinfo" id="T1:U444">-<span class="var type1" id="S79T1U2416">krho</span></span>*<span class="var type1" id="S117T19U2417">gD_TM</span></span>/<span class="mxinfo" id="T1:U447">4</span></span>/<span class="mxinfo" id="T1:U448">pi</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,274" id="srcline274">274</a></span><span class="line">    <span class="mxinfo" id="T19:U449"><span class="var type1" id="S121T19U2423">J1</span>                = <span class="mxinfo" id="T19:U451"><span class="mxinfo" id="T19:U452"><span class="mxinfo" id="T19:U453">-(<span class="mxinfo" id="T19:U454"><span class="var type1" id="S113T19U2429">gD_TE</span> - <span class="var type1" id="S117T19U2430">gD_TM</span></span>)</span>/<span class="mxinfo" id="T1:U457">4</span></span>/<span class="mxinfo" id="T1:U458">pi</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,275" id="srcline275">275</a></span><span class="line">    <span class="mxinfo" id="T19:U459"><span class="var type1" id="S122T19U2436">J1V</span>               = <span class="mxinfo" id="T19:U461"><span class="mxinfo" id="T19:U462"><span class="mxinfo" id="T19:U463"><span class="mxinfo" id="T1:U464"><span class="var type1" id="S79T1U2441">krho</span>^2</span>*<span class="var type1" id="S119T19U2443">gC_TM</span></span>*<span class="mxinfo" id="T19:U467">1i</span></span>/(<span class="mxinfo" id="T19:U468"><span class="mxinfo" id="T1:U469"><span class="mxinfo" id="T1:U470">4*pi</span>*<span class="var type1" id="S89T1U2452">omega</span></span>*<span class="mxinfo" id="T19:U472"><span class="var type1" id="S90T33U2454">epsc</span>(<span class="mxinfo" id="T1:U474">2</span>,<span class="var type1" id="S99T1U2456">iTxLayer</span>)</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,276" id="srcline276">276</a></span><span class="line">    <span class="mxinfo" id="T44:U476"><span class="var type1" id="S76T44U2459">HbKernels</span>         = <span class="mxinfo" id="T44:U478">[<span class="var type1" id="S120T19U2462">J0</span>; <span class="var type1" id="S121T19U2464">J1</span> ; <span class="var type1" id="S122T19U2466">J1V</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,277" id="srcline277">277</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,278" id="srcline278">278</a></span><span class="line">    <span class="comment">%Ez</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,279" id="srcline279">279</a></span><span class="line">    <span class="mxinfo" id="T19:U482"><span class="var type1" id="S123T19U2469">J0V</span>               = <span class="mxinfo" id="T19:U484"><span class="mxinfo" id="T19:U485"><span class="mxinfo" id="T19:U486"><span class="mxinfo" id="T1:U487">-<span class="mxinfo" id="T1:U488"><span class="var type1" id="S79T1U2475">krho</span>^3</span></span>*<span class="var type1" id="S119T19U2477">gC_TM</span></span>*<span class="mxinfo" id="T1:U491">1</span></span>/(<span class="mxinfo" id="T19:U492"><span class="mxinfo" id="T1:U493"><span class="mxinfo" id="T1:U494">4*pi</span>*<span class="mxinfo" id="T1:U495"><span class="var type1" id="S89T1U2487">omega</span>^2</span></span>*<span class="mxinfo" id="T19:U497"><span class="mxinfo" id="T19:U498"><span class="var type1" id="S90T33U2491">epsc</span>(<span class="mxinfo" id="T1:U500">2</span>,<span class="var type1" id="S99T1U2493">iTxLayer</span>)</span>^2</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,280" id="srcline280">280</a></span><span class="line">    <span class="mxinfo" id="T19:U502"><span class="var type1" id="S121T19U2497">J1</span>                = <span class="mxinfo" id="T19:U504"><span class="mxinfo" id="T19:U505"><span class="mxinfo" id="T19:U506"><span class="mxinfo" id="T1:U507"><span class="var type1" id="S79T1U2502">krho</span>^2</span>*<span class="var type1" id="S117T19U2504">gD_TM</span></span>*<span class="mxinfo" id="T19:U510">1i</span></span>/(<span class="mxinfo" id="T19:U511"><span class="mxinfo" id="T1:U512"><span class="mxinfo" id="T1:U513">4*pi</span>*<span class="var type1" id="S89T1U2513">omega</span></span>*<span class="mxinfo" id="T19:U515"><span class="var type1" id="S90T33U2515">epsc</span>(<span class="mxinfo" id="T1:U517">2</span>,<span class="var type1" id="S99T1U2517">iTxLayer</span>)</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,281" id="srcline281">281</a></span><span class="line">    <span class="mxinfo" id="T45:U519"><span class="var type1" id="S77T45U2520">EzKernels</span>         = <span class="mxinfo" id="T45:U521">[<span class="var type1" id="S123T19U2523">J0V</span>; <span class="var type1" id="S121T19U2525">J1</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,282" id="srcline282">282</a></span><span class="line">    <span class="comment">% needs multiplication by 1i/omega/epsc(2,iTxLayer) after hankel </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,283" id="srcline283">283</a></span><span class="line">    <span class="comment">% transform (done here)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,284" id="srcline284">284</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,285" id="srcline285">285</a></span><span class="line">    <span class="comment">%Hz</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,286" id="srcline286">286</a></span><span class="line">    <span class="mxinfo" id="T19:U524"><span class="var type1" id="S78T19U2528">HzKernels</span>         = <span class="mxinfo" id="T19:U526"><span class="mxinfo" id="T19:U527"><span class="mxinfo" id="T19:U528"><span class="mxinfo" id="T1:U529"><span class="var type1" id="S79T1U2533">krho</span>^2</span>*<span class="var type1" id="S112T19U2535">gA_TE</span></span>*<span class="mxinfo" id="T19:U532">1i</span></span>/(<span class="mxinfo" id="T1:U533"><span class="mxinfo" id="T1:U534"><span class="mxinfo" id="T1:U535"><span class="var type1" id="S89T1U2541">omega</span>*<span class="mxinfo" id="T1:U537"><span class="var type1" id="S86T1U2542">mu</span></span></span>*<span class="mxinfo" id="T1:U539">4</span></span>*<span class="mxinfo" id="T1:U540">pi</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,287" id="srcline287">287</a></span><span class="line">    <span class="comment">% needs multiplication by 1i/omega/mu after hankel </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,288" id="srcline288">288</a></span><span class="line">    <span class="comment">% transform (done here)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,289" id="srcline289">289</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,290" id="srcline290">290</a></span><span class="line"><span class="comment">% we're done now</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,291" id="srcline291">291</a></span><span class="line"><span class="keyword">end</span>    </span></span>
<span class="srcline"><span class="lineno"><a href="1,292" id="srcline292">292</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,293" id="srcline293">293</a></span><span class="line"><span class="comment">%subfunctions</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,294" id="srcline294">294</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,295" id="srcline295">295</a></span><span class="line"><span class="comment">% to recursively calculate up/down stack reflectivities in the source layer</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,296" id="srcline296">296</a></span><span class="line"><span class="comment">% this can be used for either mode (TE/TM)  </span></span></span>
</pre>

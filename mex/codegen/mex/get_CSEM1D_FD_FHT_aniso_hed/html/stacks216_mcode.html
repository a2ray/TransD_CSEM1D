<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,333" id="srcline333">333</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,334" id="srcline334">334</a></span><span class="line"><span class="comment">%subfunctions</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,335" id="srcline335">335</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,336" id="srcline336">336</a></span><span class="line"><span class="comment">% to recursively calculate up/down stack reflectivities in the source layer</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,337" id="srcline337">337</a></span><span class="line"><span class="comment">% this can be used for either mode (TE/TM)  </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,338" id="srcline338">338</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S108T19U2376">Rupperstack</span>,<span class="var type1" id="S109T19U2377">Rlowerstack</span>]=stacks(<span class="var type1" id="S110T36U2380">pz</span>,<span class="var type1" id="S111T1U2381">iTxLayer</span>,<span class="var type1" id="S112T36U2382">r</span>,<span class="var type1" id="S113T3U2383">z</span>,<span class="var type1" id="S114T1U2384">omega</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,339" id="srcline339">339</a></span><span class="line">    <span class="comment">%global omega</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,340" id="srcline340">340</a></span><span class="line"><span class="comment">% The last and first layer thicknesses are infinite</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,341" id="srcline341">341</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,342" id="srcline342">342</a></span><span class="line">    <span class="mxinfo" id="T20:U8"><span class="var type1" id="S115T20U2387">dz</span>          = <span class="mxinfo" id="T20:U10">diff(<span class="var type1" id="S113T3U2390">z</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,343" id="srcline343">343</a></span><span class="line">    <span class="mxinfo" id="T1:U12"><span class="var type1" id="S117T1U2393">nz</span>          = <span class="mxinfo" id="T1:U14">length(<span class="var type1" id="S113T3U2396">z</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,344" id="srcline344">344</a></span><span class="line">    <span class="mxinfo" id="T3:U16"><span class="var type1" id="S119T3U2399">d</span>           = <span class="mxinfo" id="T3:U18">zeros (<span class="mxinfo" id="T1:U19">1</span>,<span class="var type1" id="S117T1U2403">nz</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,345" id="srcline345">345</a></span><span class="line">    <span class="mxinfo" id="T1:U21"><span class="mxinfo" id="T1:U22"><span class="var type1" id="S119T3U2407">d</span>(<span class="mxinfo" id="T1:U24">1</span>)</span>        = <span class="mxinfo" id="T1:U25">1d60</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,346" id="srcline346">346</a></span><span class="line">    <span class="mxinfo" id="T3:U26"><span class="mxinfo" id="T3:U27"><span class="var type1" id="S119T3U2413">d</span>(<span class="mxinfo" id="T1:U29">2</span>:<span class="mxinfo" id="T1:U30"><span class="var type1" id="S117T1U2417">nz</span>-<span class="mxinfo" id="T1:U32">1</span></span>)</span>   = <span class="mxinfo" id="T3:U33"><span class="var type1" id="S115T20U2420">dz</span>(<span class="mxinfo" id="T1:U35">2</span>:<span class="mxinfo" id="T1:U36">end</span>)</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,347" id="srcline347">347</a></span><span class="line">    <span class="mxinfo" id="T1:U37"><span class="mxinfo" id="T1:U38"><span class="var type1" id="S119T3U2428">d</span>(<span class="var type1" id="S117T1U2429">nz</span>)</span>       = <span class="mxinfo" id="T1:U41">1d60</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,348" id="srcline348">348</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,349" id="srcline349">349</a></span><span class="line"><span class="comment">% Capital R is for a stack   </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,350" id="srcline350">350</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,351" id="srcline351">351</a></span><span class="line"><span class="comment">% Starting from the bottom up, for Rs_down    </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,352" id="srcline352">352</a></span><span class="line">    <span class="mxinfo" id="T19:U42"><span class="var type1" id="S109T19U2433">Rlowerstack</span>=<span class="mxinfo" id="T19:U44"><span class="mxinfo" id="T1:U45">0</span>*<span class="mxinfo" id="T19:U46">1i</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,353" id="srcline353">353</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S122T1U2439">k</span>   = (<span class="mxinfo" id="T1:U48"><span class="var type1" id="S117T1U2444">nz</span>-<span class="mxinfo" id="T1:U50">1</span></span>):<span class="mxinfo" id="T1:U51">-1</span>:<span class="var type1" id="S111T1U2448">iTxLayer</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,354" id="srcline354">354</a></span><span class="line">        <span class="mxinfo" id="T19:U53"><span class="var type1" id="S123T19U2451">Rs_d</span> = <span class="mxinfo" id="T19:U55">(<span class="mxinfo" id="T19:U56"><span class="mxinfo" id="T19:U57"><span class="var type1" id="S112T36U2456">r</span>(<span class="var type1" id="S122T1U2457">k</span>)</span> + <span class="mxinfo" id="T19:U60"><span class="var type1" id="S109T19U2459">Rlowerstack</span>*<span class="mxinfo" id="T19:U62">exp(<span class="mxinfo" id="T19:U63"><span class="mxinfo" id="T19:U64"><span class="mxinfo" id="T19:U65"><span class="mxinfo" id="T19:U66">2i</span>*<span class="var type1" id="S114T1U2466">omega</span></span>*<span class="mxinfo" id="T19:U68"><span class="var type1" id="S110T36U2468">pz</span>(<span class="mxinfo" id="T1:U70"><span class="var type1" id="S122T1U2470">k</span>+<span class="mxinfo" id="T1:U72">1</span></span>)</span></span>*<span class="mxinfo" id="T1:U73"><span class="var type1" id="S119T3U2473">d</span>(<span class="mxinfo" id="T1:U75"><span class="var type1" id="S122T1U2475">k</span>+<span class="mxinfo" id="T1:U77">1</span></span>)</span></span>)</span></span></span>)/<span class="keyword">...</span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,355" id="srcline355">355</a></span><span class="line"><span class="mxinfo" id="T19:U53"><span class="mxinfo" id="T19:U55">              (<span class="mxinfo" id="T19:U78"><span class="mxinfo" id="T1:U79">1</span> + <span class="mxinfo" id="T19:U80"><span class="mxinfo" id="T19:U81"><span class="mxinfo" id="T19:U82"><span class="var type1" id="S112T36U2483">r</span>(<span class="var type1" id="S122T1U2484">k</span>)</span>*<span class="var type1" id="S109T19U2485">Rlowerstack</span></span>*<span class="keyword">...</span></span></span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,356" id="srcline356">356</a></span><span class="line"><span class="mxinfo" id="T19:U53"><span class="mxinfo" id="T19:U55"><span class="mxinfo" id="T19:U78"><span class="mxinfo" id="T19:U80">              <span class="mxinfo" id="T19:U86">exp(<span class="mxinfo" id="T19:U87"><span class="mxinfo" id="T19:U88"><span class="mxinfo" id="T19:U89"><span class="mxinfo" id="T19:U90">2i</span>*<span class="var type1" id="S114T1U2492">omega</span></span>*<span class="mxinfo" id="T19:U92"><span class="var type1" id="S110T36U2494">pz</span>(<span class="mxinfo" id="T1:U94"><span class="var type1" id="S122T1U2496">k</span>+<span class="mxinfo" id="T1:U96">1</span></span>)</span></span>*<span class="mxinfo" id="T1:U97"><span class="var type1" id="S119T3U2499">d</span>(<span class="mxinfo" id="T1:U99"><span class="var type1" id="S122T1U2501">k</span>+<span class="mxinfo" id="T1:U101">1</span></span>)</span></span>)</span></span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,357" id="srcline357">357</a></span><span class="line">        <span class="mxinfo" id="T19:U102"><span class="var type1" id="S109T19U2505">Rlowerstack</span>=<span class="var type1" id="S123T19U2506">Rs_d</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,358" id="srcline358">358</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,359" id="srcline359">359</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,360" id="srcline360">360</a></span><span class="line">    <span class="mxinfo" id="T19:U105"><span class="var type1" id="S108T19U2509">Rupperstack</span>=<span class="mxinfo" id="T19:U107"><span class="mxinfo" id="T1:U108">0</span>*<span class="mxinfo" id="T19:U109">1i</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,361" id="srcline361">361</a></span><span class="line"><span class="comment">% Starting from the top down for Rs_up</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,362" id="srcline362">362</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S122T1U2515">k</span>   = <span class="mxinfo" id="T1:U111">2</span>:<span class="var type1" id="S111T1U2518">iTxLayer</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,363" id="srcline363">363</a></span><span class="line">        <span class="mxinfo" id="T19:U113"><span class="var type1" id="S125T19U2521">Rs_u</span> = <span class="mxinfo" id="T19:U115">(<span class="mxinfo" id="T19:U116"><span class="mxinfo" id="T19:U117">-<span class="mxinfo" id="T19:U118"><span class="var type1" id="S112T36U2527">r</span>(<span class="mxinfo" id="T1:U120"><span class="var type1" id="S122T1U2529">k</span>-<span class="mxinfo" id="T1:U122">1</span></span>)</span></span> + <span class="mxinfo" id="T19:U123"><span class="var type1" id="S108T19U2532">Rupperstack</span>*<span class="mxinfo" id="T19:U125">exp(<span class="mxinfo" id="T19:U126"><span class="mxinfo" id="T19:U127"><span class="mxinfo" id="T19:U128"><span class="mxinfo" id="T19:U129">2i</span>*<span class="var type1" id="S114T1U2539">omega</span></span>*<span class="mxinfo" id="T19:U131"><span class="var type1" id="S110T36U2541">pz</span>(<span class="mxinfo" id="T1:U133"><span class="var type1" id="S122T1U2543">k</span>-<span class="mxinfo" id="T1:U135">1</span></span>)</span></span>*<span class="mxinfo" id="T1:U136"><span class="var type1" id="S119T3U2546">d</span>(<span class="mxinfo" id="T1:U138"><span class="var type1" id="S122T1U2548">k</span>-<span class="mxinfo" id="T1:U140">1</span></span>)</span></span>)</span></span></span>)/<span class="keyword">...</span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,364" id="srcline364">364</a></span><span class="line"><span class="mxinfo" id="T19:U113"><span class="mxinfo" id="T19:U115">              (<span class="mxinfo" id="T19:U141"><span class="mxinfo" id="T1:U142">1</span> - <span class="mxinfo" id="T19:U143"><span class="mxinfo" id="T19:U144"><span class="mxinfo" id="T19:U145"><span class="var type1" id="S112T36U2556">r</span>(<span class="mxinfo" id="T1:U147"><span class="var type1" id="S122T1U2558">k</span>-<span class="mxinfo" id="T1:U149">1</span></span>)</span>*<span class="var type1" id="S108T19U2560">Rupperstack</span></span>*<span class="keyword">...</span></span></span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,365" id="srcline365">365</a></span><span class="line"><span class="mxinfo" id="T19:U113"><span class="mxinfo" id="T19:U115"><span class="mxinfo" id="T19:U141"><span class="mxinfo" id="T19:U143">              <span class="mxinfo" id="T19:U151">exp(<span class="mxinfo" id="T19:U152"><span class="mxinfo" id="T19:U153"><span class="mxinfo" id="T19:U154"><span class="mxinfo" id="T19:U155">2i</span>*<span class="var type1" id="S114T1U2567">omega</span></span>*<span class="mxinfo" id="T19:U157"><span class="var type1" id="S110T36U2569">pz</span>(<span class="mxinfo" id="T1:U159"><span class="var type1" id="S122T1U2571">k</span>-<span class="mxinfo" id="T1:U161">1</span></span>)</span></span>*<span class="mxinfo" id="T1:U162"><span class="var type1" id="S119T3U2574">d</span>(<span class="mxinfo" id="T1:U164"><span class="var type1" id="S122T1U2576">k</span>-<span class="mxinfo" id="T1:U166">1</span></span>)</span></span>)</span></span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,366" id="srcline366">366</a></span><span class="line">        <span class="mxinfo" id="T19:U167"><span class="var type1" id="S108T19U2580">Rupperstack</span>=<span class="var type1" id="S125T19U2581">Rs_u</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,367" id="srcline367">367</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,368" id="srcline368">368</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,369" id="srcline369">369</a></span><span class="line"></span></span>
</pre>

<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,225" id="srcline225">225</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,226" id="srcline226">226</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S62T46U1743">ErKernels</span>,<span class="var type1" id="S63T46U1744">EbKernels</span>,<span class="var type1" id="S64T46U1745">HrKernels</span>,<span class="var type1" id="S65T46U1746">HbKernels</span>,<span class="var type1" id="S66T19U1747">EzKernels</span>,<span class="var type1" id="S67T19U1748">HzKernels</span>]<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,227" id="srcline227">227</a></span><span class="line">        = getCSEM1DKernels_aniso_hed(<span class="var type1" id="S68T1U1751">krho</span>,<span class="var type1" id="S69T1U1752">f</span>,<span class="var type1" id="S70T1U1753">zRx</span>,<span class="var type1" id="S71T1U1754">zTx</span>,<span class="var type1" id="S72T3U1755">z</span>,<span class="var type1" id="S73T34U1756">sig</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,228" id="srcline228">228</a></span><span class="line"><span class="comment">%sig(1,:) contains the horizontal conductivities</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,229" id="srcline229">229</a></span><span class="line"><span class="comment">%sig(2,:) contains the vertical conductivities</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,230" id="srcline230">230</a></span><span class="line">coder.extrinsic (<span class="string">'beep'</span>,<span class="string">'disp'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,231" id="srcline231">231</a></span><span class="line"><span class="comment">%a codegen debug</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,232" id="srcline232">232</a></span><span class="line"><span class="mxinfo" id="T46:U13"><span class="var type1" id="S62T46U1766">ErKernels</span>         = <span class="mxinfo" id="T46:U15">[<span class="mxinfo" id="T19:U16">1i</span>; <span class="mxinfo" id="T19:U17">1i</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,233" id="srcline233">233</a></span><span class="line"><span class="mxinfo" id="T46:U18"><span class="var type1" id="S63T46U1774">EbKernels</span>         = <span class="mxinfo" id="T46:U20">[<span class="mxinfo" id="T19:U21">1i</span>; <span class="mxinfo" id="T19:U22">1i</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,234" id="srcline234">234</a></span><span class="line"><span class="mxinfo" id="T19:U23"><span class="var type1" id="S66T19U1782">EzKernels</span>         = <span class="mxinfo" id="T19:U25">[1i]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,235" id="srcline235">235</a></span><span class="line"><span class="mxinfo" id="T46:U26"><span class="var type1" id="S64T46U1788">HrKernels</span>         = <span class="mxinfo" id="T46:U28">[<span class="mxinfo" id="T19:U29">1i</span>; <span class="mxinfo" id="T19:U30">1i</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,236" id="srcline236">236</a></span><span class="line"><span class="mxinfo" id="T46:U31"><span class="var type1" id="S65T46U1796">HbKernels</span>         = <span class="mxinfo" id="T46:U33">[<span class="mxinfo" id="T19:U34">1i</span>; <span class="mxinfo" id="T19:U35">1i</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,237" id="srcline237">237</a></span><span class="line"><span class="mxinfo" id="T19:U36"><span class="var type1" id="S67T19U1804">HzKernels</span>         = <span class="mxinfo" id="T19:U38">[1i]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,238" id="srcline238">238</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,239" id="srcline239">239</a></span><span class="line"><span class="comment">% set the origin to zTx=0</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,240" id="srcline240">240</a></span><span class="line">    <span class="mxinfo" id="T3:U39"><span class="var type1" id="S72T3U1810">z</span>       = <span class="mxinfo" id="T3:U41"><span class="var type1" id="S72T3U1812">z</span>-<span class="var type1" id="S71T1U1813">zTx</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,241" id="srcline241">241</a></span><span class="line">    <span class="mxinfo" id="T1:U44"><span class="var type1" id="S70T1U1816">zRx</span>     = <span class="mxinfo" id="T1:U46"><span class="var type1" id="S70T1U1818">zRx</span>-<span class="var type1" id="S71T1U1819">zTx</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,242" id="srcline242">242</a></span><span class="line">    <span class="mxinfo" id="T1:U49"><span class="var type1" id="S71T1U1822">zTx</span>     = <span class="mxinfo" id="T1:U51">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,243" id="srcline243">243</a></span><span class="line"><span class="comment">% will need these variables</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,244" id="srcline244">244</a></span><span class="line">    <span class="mxinfo" id="T1:U52"><span class="var type1" id="S75T1U1826">mu</span>      = <span class="mxinfo" id="T1:U54">4*pi*10^-7</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,245" id="srcline245">245</a></span><span class="line">    <span class="mxinfo" id="T1:U55"><span class="var type1" id="S77T1U1838">eps0</span>    = <span class="mxinfo" id="T1:U57">8.854e-12</span></span>;<span class="comment">%won't need</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,246" id="srcline246">246</a></span><span class="line">    <span class="comment">%global omega   </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,247" id="srcline247">247</a></span><span class="line">    <span class="mxinfo" id="T1:U58"><span class="var type1" id="S78T1U1842">omega</span> = <span class="mxinfo" id="T1:U60"><span class="mxinfo" id="T1:U61">2*pi</span>*<span class="var type1" id="S69T1U1848">f</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,248" id="srcline248">248</a></span><span class="line">    <span class="mxinfo" id="T35:U63"><span class="var type1" id="S79T35U1851">epsc</span>    = <span class="mxinfo" id="T35:U65"><span class="var type1" id="S77T1U1853">eps0</span> + <span class="mxinfo" id="T35:U67"><span class="mxinfo" id="T35:U68"><span class="mxinfo" id="T19:U69">1i</span>*<span class="var type1" id="S73T34U1857">sig</span></span>/<span class="var type1" id="S78T1U1858">omega</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,249" id="srcline249">249</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,250" id="srcline250">250</a></span><span class="line"><span class="comment">% prho=krho/omega</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,251" id="srcline251">251</a></span><span class="line">    <span class="mxinfo" id="T36:U72"><span class="var type1" id="S80T36U1861">pzI</span>=<span class="mxinfo" id="T36:U74">sqrt(<span class="mxinfo" id="T36:U75"><span class="mxinfo" id="T36:U76"><span class="mxinfo" id="T1:U77"><span class="var type1" id="S75T1U1866">mu</span></span>*<span class="mxinfo" id="T36:U79"><span class="var type1" id="S79T35U1868">epsc</span>(<span class="mxinfo" id="T1:U81">1</span>,:)</span></span> - <span class="mxinfo" id="T1:U82">(<span class="mxinfo" id="T1:U83"><span class="var type1" id="S68T1U1874">krho</span>/<span class="var type1" id="S78T1U1875">omega</span></span>)^2</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,252" id="srcline252">252</a></span><span class="line">    <span class="mxinfo" id="T36:U86"><span class="var type1" id="S82T36U1879">pzII</span>=<span class="mxinfo" id="T36:U88">sqrt(<span class="mxinfo" id="T36:U89"><span class="mxinfo" id="T36:U90"><span class="mxinfo" id="T1:U91"><span class="var type1" id="S75T1U1884">mu</span></span>*<span class="mxinfo" id="T36:U93"><span class="var type1" id="S79T35U1886">epsc</span>(<span class="mxinfo" id="T1:U95">1</span>,:)</span></span> - <span class="mxinfo" id="T36:U96"><span class="mxinfo" id="T36:U97"><span class="mxinfo" id="T36:U98"><span class="var type1" id="S79T35U1892">epsc</span>(<span class="mxinfo" id="T1:U100">1</span>,:)</span>./<span class="mxinfo" id="T36:U101"><span class="var type1" id="S79T35U1896">epsc</span>(<span class="mxinfo" id="T1:U103">2</span>,:)</span></span>*<span class="mxinfo" id="T1:U104">(<span class="mxinfo" id="T1:U105"><span class="var type1" id="S68T1U1902">krho</span>/<span class="var type1" id="S78T1U1903">omega</span></span>)^2</span></span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,253" id="srcline253">253</a></span><span class="line">    <span class="comment">%sanity check for wavenumber</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,254" id="srcline254">254</a></span><span class="line">    <span class="mxinfo" id="T38:U108"><span class="var type1" id="S83T38U1907">index</span>=<span class="mxinfo" id="T38:U110"><span class="mxinfo" id="T3:U111">imag(<span class="var type1" id="S80T36U1911">pzI</span>)</span>&lt;<span class="mxinfo" id="T1:U113">0</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,255" id="srcline255">255</a></span><span class="line">    <span class="mxinfo" id="T36:U114"><span class="mxinfo" id="T36:U115"><span class="var type1" id="S80T36U1916">pzI</span>(<span class="var type1" id="S83T38U1917">index</span>)</span>=<span class="mxinfo" id="T36:U118">-<span class="mxinfo" id="T36:U119"><span class="var type1" id="S80T36U1920">pzI</span>(<span class="var type1" id="S83T38U1921">index</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,256" id="srcline256">256</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,257" id="srcline257">257</a></span><span class="line">    <span class="mxinfo" id="T38:U122"><span class="var type1" id="S83T38U1924">index</span>=<span class="mxinfo" id="T38:U124"><span class="mxinfo" id="T3:U125">imag(<span class="var type1" id="S82T36U1928">pzII</span>)</span>&lt;<span class="mxinfo" id="T1:U127">0</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,258" id="srcline258">258</a></span><span class="line">    <span class="mxinfo" id="T36:U128"><span class="mxinfo" id="T36:U129"><span class="var type1" id="S82T36U1933">pzII</span>(<span class="var type1" id="S83T38U1934">index</span>)</span>=<span class="mxinfo" id="T36:U132">-<span class="mxinfo" id="T36:U133"><span class="var type1" id="S82T36U1937">pzII</span>(<span class="var type1" id="S83T38U1938">index</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,259" id="srcline259">259</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,260" id="srcline260">260</a></span><span class="line"><span class="comment">% reflection coefficients (downward) for an interface: pzI for TE, pzII for TM   </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,261" id="srcline261">261</a></span><span class="line">    <span class="mxinfo" id="T36:U136"><span class="var type1" id="S85T36U1941">rTE</span>=<span class="mxinfo" id="T36:U138">(<span class="mxinfo" id="T36:U139"><span class="mxinfo" id="T36:U140"><span class="var type1" id="S80T36U1946">pzI</span>(<span class="mxinfo" id="T1:U142">1</span>:<span class="mxinfo" id="T1:U143"><span class="mxinfo" id="T1:U144">end</span>-<span class="mxinfo" id="T1:U145">1</span></span>)</span> - <span class="mxinfo" id="T36:U146"><span class="var type1" id="S80T36U1954">pzI</span>(<span class="mxinfo" id="T1:U148">2</span>:<span class="mxinfo" id="T1:U149">end</span>)</span></span>)./(<span class="mxinfo" id="T36:U150"><span class="mxinfo" id="T36:U151"><span class="var type1" id="S80T36U1962">pzI</span>(<span class="mxinfo" id="T1:U153">1</span>:<span class="mxinfo" id="T1:U154"><span class="mxinfo" id="T1:U155">end</span>-<span class="mxinfo" id="T1:U156">1</span></span>)</span> + <span class="mxinfo" id="T36:U157"><span class="var type1" id="S80T36U1970">pzI</span>(<span class="mxinfo" id="T1:U159">2</span>:<span class="mxinfo" id="T1:U160">end</span>)</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,262" id="srcline262">262</a></span><span class="line">    <span class="mxinfo" id="T36:U161"><span class="var type1" id="S87T36U1977">rTM</span>=<span class="mxinfo" id="T36:U163">(<span class="mxinfo" id="T36:U164"><span class="mxinfo" id="T36:U165"><span class="mxinfo" id="T36:U166"><span class="var type1" id="S79T35U1983">epsc</span>(<span class="mxinfo" id="T1:U168">1</span>,<span class="mxinfo" id="T1:U169"><span class="mxinfo" id="T1:U170">1</span>:<span class="mxinfo" id="T1:U171"><span class="mxinfo" id="T1:U172">end</span>-<span class="mxinfo" id="T1:U173">1</span></span></span>)</span>.*<span class="mxinfo" id="T36:U174"><span class="var type1" id="S82T36U1992">pzII</span>(<span class="mxinfo" id="T1:U176">2</span>:<span class="mxinfo" id="T1:U177">end</span>)</span></span> - <span class="mxinfo" id="T36:U178"><span class="mxinfo" id="T36:U179"><span class="var type1" id="S79T35U1999">epsc</span>(<span class="mxinfo" id="T1:U181">1</span>,<span class="mxinfo" id="T1:U182"><span class="mxinfo" id="T1:U183">2</span>:<span class="mxinfo" id="T1:U184">end</span></span>)</span>.*<span class="mxinfo" id="T36:U185"><span class="var type1" id="S82T36U2006">pzII</span>(<span class="mxinfo" id="T1:U187">1</span>:<span class="mxinfo" id="T1:U188"><span class="mxinfo" id="T1:U189">end</span>-<span class="mxinfo" id="T1:U190">1</span></span>)</span></span></span>)./<span class="keyword">...</span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,263" id="srcline263">263</a></span><span class="line"><span class="mxinfo" id="T36:U161"><span class="mxinfo" id="T36:U163">        (<span class="mxinfo" id="T36:U191"><span class="mxinfo" id="T36:U192"><span class="mxinfo" id="T36:U193"><span class="var type1" id="S79T35U2017">epsc</span>(<span class="mxinfo" id="T1:U195">1</span>,<span class="mxinfo" id="T1:U196"><span class="mxinfo" id="T1:U197">1</span>:<span class="mxinfo" id="T1:U198"><span class="mxinfo" id="T1:U199">end</span>-<span class="mxinfo" id="T1:U200">1</span></span></span>)</span>.*<span class="mxinfo" id="T36:U201"><span class="var type1" id="S82T36U2026">pzII</span>(<span class="mxinfo" id="T1:U203">2</span>:<span class="mxinfo" id="T1:U204">end</span>)</span></span> + <span class="mxinfo" id="T36:U205"><span class="mxinfo" id="T36:U206"><span class="var type1" id="S79T35U2033">epsc</span>(<span class="mxinfo" id="T1:U208">1</span>,<span class="mxinfo" id="T1:U209"><span class="mxinfo" id="T1:U210">2</span>:<span class="mxinfo" id="T1:U211">end</span></span>)</span>.*<span class="mxinfo" id="T36:U212"><span class="var type1" id="S82T36U2040">pzII</span>(<span class="mxinfo" id="T1:U214">1</span>:<span class="mxinfo" id="T1:U215"><span class="mxinfo" id="T1:U216">end</span>-<span class="mxinfo" id="T1:U217">1</span></span>)</span></span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,264" id="srcline264">264</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,265" id="srcline265">265</a></span><span class="line"><span class="comment">%         % Find the layer containing the transmitter:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,266" id="srcline266">266</a></span><span class="line">    <span class="comment">%for codegen, hardcoding</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,267" id="srcline267">267</a></span><span class="line"><span class="comment">%    iTxLayer =2;iRxLayer =2;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,268" id="srcline268">268</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,269" id="srcline269">269</a></span><span class="line">            <span class="mxinfo" id="T3:U218"><span class="var type1" id="S88T3U2049">iTxLayer</span> = <span class="mxinfo" id="T3:U220">find(<span class="mxinfo" id="T38:U221"><span class="var type1" id="S72T3U2053">z</span>&lt;<span class="var type1" id="S71T1U2054">zTx</span></span>,1,<span class="string">'last'</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,270" id="srcline270">270</a></span><span class="line">            <span class="keyword">if</span> <span class="mxinfo" id="T5:U224">isempty(<span class="var type1" id="S88T3U2061">iTxLayer</span>)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,271" id="srcline271">271</a></span><span class="line">                <span class="mxinfo" id="T3:U226"><span class="var type1" id="S88T3U2064">iTxLayer</span> = <span class="mxinfo" id="T1:U228">length(<span class="var type1" id="S72T3U2067">z</span>)</span></span>; <span class="comment">% in the last layer</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,272" id="srcline272">272</a></span><span class="line">            <span class="keyword">end</span>    </span></span>
<span class="srcline"><span class="lineno"><a href="1,273" id="srcline273">273</a></span><span class="line">        <span class="mxinfo" id="T1:U230"><span class="var type1" id="S88T1U2070">iTxLayer</span> =<span class="mxinfo" id="T1:U232"><span class="var type1" id="S88T3U2072">iTxLayer</span>(<span class="mxinfo" id="T1:U234">1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,274" id="srcline274">274</a></span><span class="line">        <span class="comment">% Find the layer containing the receiver:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,275" id="srcline275">275</a></span><span class="line">        <span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,276" id="srcline276">276</a></span><span class="line">            <span class="mxinfo" id="T3:U235"><span class="var type1" id="S92T3U2076">iRxLayer</span> = <span class="mxinfo" id="T3:U237">find(<span class="mxinfo" id="T38:U238"><span class="var type1" id="S72T3U2080">z</span>&lt;<span class="var type1" id="S70T1U2081">zRx</span></span>,1,<span class="string">'last'</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,277" id="srcline277">277</a></span><span class="line">            <span class="keyword">if</span> <span class="mxinfo" id="T5:U241">isempty(<span class="var type1" id="S92T3U2088">iRxLayer</span>)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,278" id="srcline278">278</a></span><span class="line">                <span class="mxinfo" id="T3:U243"><span class="var type1" id="S92T3U2091">iRxLayer</span> = <span class="mxinfo" id="T1:U245">length(<span class="var type1" id="S72T3U2094">z</span>)</span></span>; <span class="comment">% in the last layer</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,279" id="srcline279">279</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,280" id="srcline280">280</a></span><span class="line">        <span class="mxinfo" id="T1:U247"><span class="var type1" id="S92T1U2097">iRxLayer</span> =<span class="mxinfo" id="T1:U249"><span class="var type1" id="S92T3U2099">iRxLayer</span>(<span class="mxinfo" id="T1:U251">1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,281" id="srcline281">281</a></span><span class="line">            <span class="keyword">if</span> <span class="mxinfo" id="T5:U252"><span class="var type1" id="S88T1U2104">iTxLayer</span> ~= <span class="var type1" id="S92T1U2105">iRxLayer</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,282" id="srcline282">282</a></span><span class="line">                <span class="extrinsicFcn" id="F305N2:B2108">beep</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,283" id="srcline283">283</a></span><span class="line">                <span class="extrinsicFcn" id="F306N3:B2111">disp</span>(<span class="string">'Error, transmitter and receiver need to be located in the same layer! Stopping'</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,284" id="srcline284">284</a></span><span class="line">                <span class="keyword">return</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,285" id="srcline285">285</a></span><span class="line">            <span class="keyword">end</span>  </span></span>
<span class="srcline"><span class="lineno"><a href="1,286" id="srcline286">286</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,287" id="srcline287">287</a></span><span class="line"><span class="comment">% kernels</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,288" id="srcline288">288</a></span><span class="line"><span class="comment">% TE mode, pzI</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,289" id="srcline289">289</a></span><span class="line">    <span class="mxinfo" id="T19:U255">[<span class="var type1" id="S95T19U2117">Rs_u</span>,<span class="var type1" id="S96T19U2118">Rs_d</span>]       = <span class="fcn" id="F216N10:B2120">stacks</span>(<span class="var type1" id="S80T36U2121">pzI</span>,<span class="var type1" id="S88T1U2122">iTxLayer</span>,<span class="var type1" id="S85T36U2123">rTE</span>,<span class="var type1" id="S72T3U2124">z</span>,<span class="var type1" id="S78T1U2125">omega</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,290" id="srcline290">290</a></span><span class="line">    <span class="mxinfo" id="T19:U263">[<span class="var type1" id="S98T19U2129">curlyRA</span>,<span class="var type1" id="S99T19U2130">curlyRD</span>] = <span class="fcn" id="F217N9:B2132">get_curly_R</span>(<span class="var type1" id="S95T19U2133">Rs_u</span>,<span class="var type1" id="S96T19U2134">Rs_d</span>,<span class="mxinfo" id="T19:U268"><span class="var type1" id="S80T36U2136">pzI</span>(<span class="var type1" id="S88T1U2137">iTxLayer</span>)</span>,<span class="var type1" id="S70T1U2138">zRx</span>,<span class="var type1" id="S72T3U2139">z</span>,<span class="var type1" id="S88T1U2140">iTxLayer</span>,<span class="var type1" id="S78T1U2141">omega</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,291" id="srcline291">291</a></span><span class="line">    <span class="mxinfo" id="T19:U275"><span class="var type1" id="S101T19U2144">gA_TE</span>             = <span class="mxinfo" id="T19:U277"><span class="mxinfo" id="T19:U278"><span class="mxinfo" id="T1:U279"><span class="var type1" id="S75T1U2147">mu</span></span>/<span class="mxinfo" id="T19:U281"><span class="var type1" id="S80T36U2149">pzI</span>(<span class="var type1" id="S88T1U2150">iTxLayer</span>)</span></span>*<span class="var type1" id="S98T19U2151">curlyRA</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,292" id="srcline292">292</a></span><span class="line">    <span class="mxinfo" id="T19:U285"><span class="var type1" id="S102T19U2154">gD_TE</span>             = <span class="var type1" id="S99T19U2155">curlyRD</span></span>;        </span></span>
<span class="srcline"><span class="lineno"><a href="1,293" id="srcline293">293</a></span><span class="line">    <span class="comment">%[Rs_uH,Rs_dH]     = stacks(pzI,iTxLayer,-rTE,z);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,294" id="srcline294">294</a></span><span class="line"><span class="comment">% TM mode, pzII</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,295" id="srcline295">295</a></span><span class="line">    <span class="mxinfo" id="T19:U288">[<span class="var type1" id="S95T19U2159">Rs_u</span>,<span class="var type1" id="S96T19U2160">Rs_d</span>]       = <span class="fcn" id="F216N10:B2162">stacks</span>(<span class="var type1" id="S82T36U2163">pzII</span>,<span class="var type1" id="S88T1U2164">iTxLayer</span>,<span class="var type1" id="S87T36U2165">rTM</span>,<span class="var type1" id="S72T3U2166">z</span>,<span class="var type1" id="S78T1U2167">omega</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,296" id="srcline296">296</a></span><span class="line">    <span class="mxinfo" id="T19:U296">[<span class="var type1" id="S98T19U2171">curlyRA</span>,<span class="var type1" id="S99T19U2172">curlyRD</span>] = <span class="fcn" id="F217N9:B2174">get_curly_R</span>(<span class="var type1" id="S95T19U2175">Rs_u</span>,<span class="var type1" id="S96T19U2176">Rs_d</span>,<span class="mxinfo" id="T19:U301"><span class="var type1" id="S82T36U2178">pzII</span>(<span class="var type1" id="S88T1U2179">iTxLayer</span>)</span>,<span class="var type1" id="S70T1U2180">zRx</span>,<span class="var type1" id="S72T3U2181">z</span>,<span class="var type1" id="S88T1U2182">iTxLayer</span>,<span class="var type1" id="S78T1U2183">omega</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,297" id="srcline297">297</a></span><span class="line">    <span class="mxinfo" id="T19:U308"><span class="var type1" id="S103T19U2186">gA_TM</span>             = <span class="mxinfo" id="T19:U310"><span class="mxinfo" id="T19:U311"><span class="mxinfo" id="T19:U312"><span class="var type1" id="S82T36U2190">pzII</span>(<span class="var type1" id="S88T1U2191">iTxLayer</span>)</span>/<span class="mxinfo" id="T19:U315"><span class="var type1" id="S79T35U2193">epsc</span>(<span class="mxinfo" id="T1:U317">1</span>,<span class="var type1" id="S88T1U2195">iTxLayer</span>)</span></span>*<span class="var type1" id="S98T19U2196">curlyRA</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,298" id="srcline298">298</a></span><span class="line">    <span class="mxinfo" id="T19:U320"><span class="var type1" id="S104T19U2199">gD_TM</span>             = <span class="var type1" id="S99T19U2200">curlyRD</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,299" id="srcline299">299</a></span><span class="line">    <span class="comment">%[Rs_uH,Rs_dH]     = stacks(pzII,iTxLayer,-rTM,z);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,300" id="srcline300">300</a></span><span class="line"><span class="comment">% Kernels according to Loseth, without the bessel functions multiplied</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,301" id="srcline301">301</a></span><span class="line">    <span class="comment">%Er</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,302" id="srcline302">302</a></span><span class="line">    <span class="mxinfo" id="T19:U323"><span class="var type1" id="S105T19U2203">J0</span>                = <span class="mxinfo" id="T19:U325"><span class="mxinfo" id="T19:U326"><span class="mxinfo" id="T19:U327"><span class="mxinfo" id="T1:U328">-<span class="var type1" id="S68T1U2208">krho</span></span>*<span class="var type1" id="S103T19U2209">gA_TM</span></span>/<span class="mxinfo" id="T1:U331">4</span></span>/<span class="mxinfo" id="T1:U332">pi</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,303" id="srcline303">303</a></span><span class="line">    <span class="mxinfo" id="T19:U333"><span class="var type1" id="S106T19U2215">J1</span>                = <span class="mxinfo" id="T19:U335"><span class="mxinfo" id="T19:U336"><span class="mxinfo" id="T19:U337">-(<span class="mxinfo" id="T19:U338"><span class="var type1" id="S101T19U2221">gA_TE</span> - <span class="var type1" id="S103T19U2222">gA_TM</span></span>)</span>/<span class="mxinfo" id="T1:U341">4</span></span>/<span class="mxinfo" id="T1:U342">pi</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,304" id="srcline304">304</a></span><span class="line">    <span class="mxinfo" id="T46:U343"><span class="var type1" id="S62T46U2228">ErKernels</span>         = <span class="mxinfo" id="T46:U345">[<span class="var type1" id="S105T19U2231">J0</span>; <span class="var type1" id="S106T19U2233">J1</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,305" id="srcline305">305</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,306" id="srcline306">306</a></span><span class="line">    <span class="comment">%Eb</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,307" id="srcline307">307</a></span><span class="line">    <span class="mxinfo" id="T19:U348"><span class="var type1" id="S105T19U2236">J0</span>                = <span class="mxinfo" id="T19:U350"><span class="mxinfo" id="T19:U351"><span class="mxinfo" id="T19:U352"><span class="var type1" id="S68T1U2240">krho</span>*<span class="var type1" id="S101T19U2241">gA_TE</span></span>/<span class="mxinfo" id="T1:U355">4</span></span>/<span class="mxinfo" id="T1:U356">pi</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,308" id="srcline308">308</a></span><span class="line">    <span class="mxinfo" id="T19:U357"><span class="var type1" id="S106T19U2247">J1</span>                = <span class="mxinfo" id="T19:U359"><span class="mxinfo" id="T19:U360"><span class="mxinfo" id="T19:U361">-(<span class="mxinfo" id="T19:U362"><span class="var type1" id="S101T19U2253">gA_TE</span> - <span class="var type1" id="S103T19U2254">gA_TM</span></span>)</span>/<span class="mxinfo" id="T1:U365">4</span></span>/<span class="mxinfo" id="T1:U366">pi</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,309" id="srcline309">309</a></span><span class="line">    <span class="mxinfo" id="T46:U367"><span class="var type1" id="S63T46U2260">EbKernels</span>         = <span class="mxinfo" id="T46:U369">[<span class="var type1" id="S105T19U2263">J0</span>; <span class="var type1" id="S106T19U2265">J1</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,310" id="srcline310">310</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,311" id="srcline311">311</a></span><span class="line">    <span class="comment">%Hr</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,312" id="srcline312">312</a></span><span class="line">    <span class="mxinfo" id="T19:U372"><span class="var type1" id="S105T19U2268">J0</span>                = <span class="mxinfo" id="T19:U374"><span class="mxinfo" id="T19:U375"><span class="mxinfo" id="T19:U376"><span class="mxinfo" id="T1:U377">-<span class="var type1" id="S68T1U2273">krho</span></span>*<span class="var type1" id="S102T19U2274">gD_TE</span></span>/<span class="mxinfo" id="T1:U380">4</span></span>/<span class="mxinfo" id="T1:U381">pi</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,313" id="srcline313">313</a></span><span class="line">    <span class="mxinfo" id="T19:U382"><span class="var type1" id="S106T19U2280">J1</span>                = <span class="mxinfo" id="T19:U384"><span class="mxinfo" id="T19:U385">(<span class="mxinfo" id="T19:U386"><span class="var type1" id="S102T19U2285">gD_TE</span> - <span class="var type1" id="S104T19U2286">gD_TM</span></span>)/<span class="mxinfo" id="T1:U389">4</span></span>/<span class="mxinfo" id="T1:U390">pi</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,314" id="srcline314">314</a></span><span class="line">    <span class="mxinfo" id="T46:U391"><span class="var type1" id="S64T46U2292">HrKernels</span>         = <span class="mxinfo" id="T46:U393">[<span class="var type1" id="S105T19U2295">J0</span>; <span class="var type1" id="S106T19U2297">J1</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,315" id="srcline315">315</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,316" id="srcline316">316</a></span><span class="line">    <span class="comment">%Hb</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,317" id="srcline317">317</a></span><span class="line">    <span class="mxinfo" id="T19:U396"><span class="var type1" id="S105T19U2300">J0</span>                = <span class="mxinfo" id="T19:U398"><span class="mxinfo" id="T19:U399"><span class="mxinfo" id="T19:U400"><span class="mxinfo" id="T1:U401">-<span class="var type1" id="S68T1U2305">krho</span></span>*<span class="var type1" id="S104T19U2306">gD_TM</span></span>/<span class="mxinfo" id="T1:U404">4</span></span>/<span class="mxinfo" id="T1:U405">pi</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,318" id="srcline318">318</a></span><span class="line">    <span class="mxinfo" id="T19:U406"><span class="var type1" id="S106T19U2312">J1</span>                = <span class="mxinfo" id="T19:U408"><span class="mxinfo" id="T19:U409"><span class="mxinfo" id="T19:U410">-(<span class="mxinfo" id="T19:U411"><span class="var type1" id="S102T19U2318">gD_TE</span> - <span class="var type1" id="S104T19U2319">gD_TM</span></span>)</span>/<span class="mxinfo" id="T1:U414">4</span></span>/<span class="mxinfo" id="T1:U415">pi</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,319" id="srcline319">319</a></span><span class="line">    <span class="mxinfo" id="T46:U416"><span class="var type1" id="S65T46U2325">HbKernels</span>         = <span class="mxinfo" id="T46:U418">[<span class="var type1" id="S105T19U2328">J0</span>; <span class="var type1" id="S106T19U2330">J1</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,320" id="srcline320">320</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,321" id="srcline321">321</a></span><span class="line">    <span class="comment">%Ez</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,322" id="srcline322">322</a></span><span class="line">    <span class="mxinfo" id="T19:U421"><span class="var type1" id="S66T19U2333">EzKernels</span>         = <span class="mxinfo" id="T19:U423"><span class="mxinfo" id="T19:U424"><span class="mxinfo" id="T19:U425"><span class="mxinfo" id="T1:U426"><span class="var type1" id="S68T1U2338">krho</span>^2</span>*<span class="var type1" id="S104T19U2340">gD_TM</span></span>*<span class="mxinfo" id="T19:U429">1i</span></span>/(<span class="mxinfo" id="T19:U430"><span class="mxinfo" id="T1:U431"><span class="mxinfo" id="T1:U432">4*pi</span>*<span class="var type1" id="S78T1U2349">omega</span></span>*<span class="mxinfo" id="T19:U434"><span class="var type1" id="S79T35U2351">epsc</span>(<span class="mxinfo" id="T1:U436">2</span>,<span class="var type1" id="S88T1U2353">iTxLayer</span>)</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,323" id="srcline323">323</a></span><span class="line">    <span class="comment">% needs multiplication by 1i/omega/epsc(2,iTxLayer) after hankel </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,324" id="srcline324">324</a></span><span class="line">    <span class="comment">% transform (done here)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,325" id="srcline325">325</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,326" id="srcline326">326</a></span><span class="line">    <span class="comment">%Hz</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,327" id="srcline327">327</a></span><span class="line">    <span class="mxinfo" id="T19:U438"><span class="var type1" id="S67T19U2356">HzKernels</span>         = <span class="mxinfo" id="T19:U440"><span class="mxinfo" id="T19:U441"><span class="mxinfo" id="T19:U442"><span class="mxinfo" id="T1:U443"><span class="var type1" id="S68T1U2361">krho</span>^2</span>*<span class="var type1" id="S101T19U2363">gA_TE</span></span>*<span class="mxinfo" id="T19:U446">1i</span></span>/(<span class="mxinfo" id="T1:U447"><span class="mxinfo" id="T1:U448"><span class="mxinfo" id="T1:U449"><span class="var type1" id="S78T1U2369">omega</span>*<span class="mxinfo" id="T1:U451"><span class="var type1" id="S75T1U2370">mu</span></span></span>*<span class="mxinfo" id="T1:U453">4</span></span>*<span class="mxinfo" id="T1:U454">pi</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,328" id="srcline328">328</a></span><span class="line">    <span class="comment">% needs multiplication by 1i/omega/mu after hankel </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,329" id="srcline329">329</a></span><span class="line">    <span class="comment">% transform (done here)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,330" id="srcline330">330</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,331" id="srcline331">331</a></span><span class="line"><span class="comment">% we're done now</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,332" id="srcline332">332</a></span><span class="line"><span class="keyword">end</span>    </span></span>
<span class="srcline"><span class="lineno"><a href="1,333" id="srcline333">333</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,334" id="srcline334">334</a></span><span class="line"><span class="comment">%subfunctions</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,335" id="srcline335">335</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,336" id="srcline336">336</a></span><span class="line"><span class="comment">% to recursively calculate up/down stack reflectivities in the source layer</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,337" id="srcline337">337</a></span><span class="line"><span class="comment">% this can be used for either mode (TE/TM)  </span></span></span>
</pre>
